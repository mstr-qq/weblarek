(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();function y(e){return typeof e=="string"&&e.length>1}function v(e,t=document){if(y(e))return Array.from(t.querySelectorAll(e));if(e instanceof NodeList)return Array.from(e);if(Array.isArray(e))return e;throw new Error("Unknown selector element")}function c(e,t){if(y(e)){const r=v(e,t);if(r.length>1&&console.warn(`selector ${e} return more then one element`),r.length===0)throw new Error(`selector ${e} return nothing`);return r.pop()}if(e instanceof HTMLElement)return e;throw new Error("Unknown selector element")}function _(e){const t=c(e);if(!t.content.firstElementChild)throw new Error(`Template ${e} has no content`);return t.content.firstElementChild.cloneNode(!0)}const x="https://larek-api.nomoreparties.co/api/weblarek",k="https://larek-api.nomoreparties.co/content/weblarek",O={"софт-скил":"card__category_soft","хард-скил":"card__category_hard",кнопка:"card__category_button",дополнительное:"card__category_additional",другое:"card__category_other"},m={free:"Бесценно",label:" синопсов"},g={buy:"Купить",disabled:"Недоступно",delete:"Удалить из корзины"};var n=(e=>(e.CART_OPEN="cart:open",e.CART_CHANGED="cart:changed",e.CATALOG_CHANGED="catalog:changed",e.CARD_SELECTED="card:selected",e.SELECTED_CARD_SAVE="selected-card:save",e.BUY_CLICK="buy:click",e.MODAL_CLOSE="modal:close",e.PRODUCT_REMOVE="product:remove",e.ORDER_START="order:start",e.FORM_EDIT="form:edit",e.ORDER_SUBMIT="order:submit",e.BUYER_CAHAGED="buyer:changed",e.CONTACT_CHANGED="contact:changed",e))(n||{});class U{constructor(t){this.event=t}_productList=[];_selectedProduct;setProductList(t){this._productList=t,this.event.emit(n.CATALOG_CHANGED)}getProductList(){return this._productList}getProductById(t){return this._productList.find(r=>r.id===t)??null}setSelectedProduct(t){this._selectedProduct=t,this.event.emit(n.SELECTED_CARD_SAVE)}getSelectedProduct(){return this._selectedProduct}}class M{constructor(t){this.event=t}_purchaseProductList=[];getListFromCart(){return this._purchaseProductList}addToCart(t){this._purchaseProductList.push(t),this.event.emit(n.CART_CHANGED)}removeFromCart(t){this._purchaseProductList=this._purchaseProductList.filter(r=>r.id!==t.id),this.event.emit(n.CART_CHANGED)}clearCart(){this._purchaseProductList.length=0,this.event.emit(n.CART_CHANGED)}getTotalCartCost(){return this._purchaseProductList.reduce((t,r)=>t+(r.price??0),0)}getTotalCartCount(){return this._purchaseProductList.length}checkProductInCartById(t){return this._purchaseProductList.some(r=>r.id===t)}}class F{constructor(t){this.event=t}_payment="";_email="";_phone="";_address="";setOrderInformation(t){t.payment!==void 0&&(this._payment=t.payment,this.event.emit(n.BUYER_CAHAGED,this.getOrderInformation())),t.address!==void 0&&(this._address=t.address,this.event.emit(n.BUYER_CAHAGED,this.getOrderInformation())),t.email!==void 0&&(this._email=t.email,this.event.emit(n.CONTACT_CHANGED,this.getOrderInformation())),t.phone!==void 0&&(this._phone=t.phone,this.event.emit(n.CONTACT_CHANGED,this.getOrderInformation()))}getOrderInformation(){return{payment:this._payment,email:this._email,phone:this._phone,address:this._address}}clearOrderInformation(){this._payment="",this._email="",this._phone="",this._address="",this.event.emit(n.BUYER_CAHAGED,this.getOrderInformation()),this.event.emit(n.CONTACT_CHANGED,this.getOrderInformation())}validationOrderInformation(){const t={payment:null,email:null,phone:null,address:null};return this._payment||(t.payment="Не выбран способ оплаты"),this._address||(t.address="Не указан адрес доставки"),this._email||(t.email="Не указан корректный email"),this._phone||(t.phone="Не указан номер телефона"),t}}class G{baseUrl;options;constructor(t,r={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...r.headers??{}}}}handleResponse(t){return t.ok?t.json():t.json().then(r=>Promise.reject(r.error??t.statusText))}get(t){return fetch(this.baseUrl+t,{...this.options,method:"GET"}).then(this.handleResponse)}post(t,r,s="POST"){return fetch(this.baseUrl+t,{...this.options,method:s,body:JSON.stringify(r)}).then(this.handleResponse)}}class N{api;constructor(t){this.api=t}getProductsFromServer(){return this.api.get("/product/")}postOrderOnServer(t){return this.api.post("/order/",t)}}class H{_events;constructor(){this._events=new Map}on(t,r){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(r)}off(t,r){this._events.has(t)&&(this._events.get(t).delete(r),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,r){this._events.forEach((s,o)=>{o==="*"&&s.forEach(a=>a({eventName:t,data:r})),(o instanceof RegExp&&o.test(t)||o===t)&&s.forEach(a=>a(r))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,r){return(s={})=>{this.emit(t,{...s||{},...r||{}})}}}const u={wrapper:document.querySelector(".page__wrapper"),header:document.querySelector(".header"),page:document.querySelector(".page__wrapper"),modal:document.querySelector(".modal"),cardGalleryTemplate:document.querySelector("#card-catalog"),cardPreviewTemplate:document.querySelector("#card-preview"),cart:document.querySelector("#basket"),productInCartTemplate:document.querySelector("#card-basket"),formOrder:document.querySelector("#order"),formContacts:document.querySelector("#contacts"),successful:document.querySelector("#success")};class p{constructor(t){this.container=t}setImage(t,r,s){t&&(t.src=r,s&&(t.alt=s))}render(t){return Object.assign(this,t??{}),this.container}}class $ extends p{constructor(t,r){super(r),this.event=t,this._counterElement=c(".header__basket-counter",this.container),this._cartButton=c(".header__basket",this.container),this._cartButton.addEventListener("click",()=>{this.event.emit(n.CART_OPEN)})}_counterElement;_cartButton;set counter(t){this._counterElement.textContent=String(t)}}class j extends p{_galleryElement;constructor(t){super(t),this._galleryElement=c(".gallery",this.container)}set catalog(t){t.forEach(r=>this._galleryElement.append(r))}}class q extends p{constructor(t,r){super(r),this.event=t,this._closeButton=c(".modal__close",this.container),this._modalContent=c(".modal__content",this.container),this.container.addEventListener("click",s=>{s.target===this.container&&this.close()}),this._closeButton.addEventListener("click",()=>{this.close()})}_closeButton;_modalContent;set content(t){this._modalContent.replaceChildren(t)}open(){this.container.classList.add("modal_active")}close(){this.container.classList.remove("modal_active")}}class L extends p{_titleElement;_priceElement;constructor(t){super(t),this._titleElement=c(".card__title",this.container),this._priceElement=c(".card__price",this.container)}set title(t){this._titleElement.textContent=t}set price(t){const r=t===null?m.free:t<1e4?`${String(t)} ${m.label}`:`${t.toLocaleString("ru-RU")} ${m.label}`;this._priceElement.textContent=r}}class A extends L{_categoryElement;_imageElement;constructor(t){super(t),this._categoryElement=c(".card__category",this.container),this._imageElement=c(".card__image",this.container)}set category(t){this._categoryElement.textContent=t;for(const r in O)this._categoryElement.classList.toggle(O[r],r===t)}set image(t){this.setImage(this._imageElement,`${k}${t.replace(".svg",".png")}`,this._titleElement.textContent)}}class V extends A{constructor(t,r){super(t),r?.onClick&&this.container.addEventListener("click",r.onClick)}}class Y extends A{_descriptionElement;_cardButton;constructor(t,r){super(t),this._descriptionElement=c(".card__text",this.container),this._cardButton=c(".card__button",this.container),r?.onClick&&this.container.addEventListener("click",r.onClick)}set description(t){this._descriptionElement.textContent=t}set textButton(t){this._cardButton.textContent=t}set statusButton(t){this._cardButton.disabled=t}}class K extends p{constructor(t,r){super(r),this.event=t,this._cartList=c(".basket__list",this.container),this._cartPlaceOrderButton=c(".basket__button",this.container),this._orderSumm=c(".basket__price",this.container),this._cartPlaceOrderButton.addEventListener("click",()=>{this.event.emit(n.ORDER_START)})}_cartList;_cartPlaceOrderButton;_orderSumm;set summ(t){const r=t<1e4?`${String(t)} ${m.label}`:`${t.toLocaleString("ru-RU")} ${m.label}`;this._orderSumm.textContent=r}set listOfPosition(t){this._cartList.replaceChildren(...t)}set statusButton(t){this._cartPlaceOrderButton.disabled=t}}class z extends L{_index;_removeButton;constructor(t,r){super(t),this._index=c(".basket__item-index",this.container),this._removeButton=c(".basket__item-delete",this.container),r?.onClick&&this._removeButton.addEventListener("click",r.onClick)}set index(t){this._index.textContent=String(t)}}class T extends p{constructor(t,r){super(r),this.event=t,this._errorElement=c(".form__errors",this.container),this._buttonElement=c('[type="submit"]',this.container),this._buttonElement.addEventListener("click",s=>{s.preventDefault(),this.event.emit(n.ORDER_SUBMIT)})}_errorElement;_buttonElement;set errors(t){const r=Object.values(t).filter(s=>s!==null).join(", ");this._errorElement.textContent=r}set statusButton(t){this._buttonElement.disabled=t}}class J extends T{constructor(t,r){super(t,r),this.event=t,this._btnContainer=v('[type="button"]',this.container),this._adressInputElement=c('[name="address"]',this.container),this._btnContainer.forEach(s=>{s.addEventListener("click",()=>{s.classList.contains("button_alt-active")?this.event.emit(n.FORM_EDIT,{payment:""}):this.event.emit(n.FORM_EDIT,{payment:s.name})})}),this._adressInputElement.addEventListener("input",()=>{this.event.emit(n.FORM_EDIT,{address:this._adressInputElement.value})})}_btnContainer;_adressInputElement;set payment(t){this._btnContainer.forEach(r=>{r.getAttribute("name")===t?r.classList.add("button_alt-active"):r.classList.remove("button_alt-active")})}set address(t){this._adressInputElement.value=t}}class Q extends T{constructor(t,r){super(t,r),this.event=t,this._emailInputElement=c('[name="email"]',this.container),this._phoneInputElement=c('[name="phone"]',this.container),this._emailInputElement.addEventListener("input",()=>{this.event.emit(n.FORM_EDIT,{email:this._emailInputElement.value})}),this._phoneInputElement.addEventListener("input",()=>{this.event.emit(n.FORM_EDIT,{phone:this._phoneInputElement.value})})}_emailInputElement;_phoneInputElement;set email(t){this._emailInputElement.value=t}set phone(t){this._phoneInputElement.value=t}}class W extends p{constructor(t,r){super(r),this.event=t,this._summElement=c(".order-success__description",this.container),this._buttonElement=c(".order-success__close",this.container),this._buttonElement.addEventListener("click",s=>{s.preventDefault(),this.event.emit(n.MODAL_CLOSE)})}_summElement;_buttonElement;set summ(t){const r=t<1e4?`Списано ${String(t)} ${m.label}`:`Списано ${t.toLocaleString("ru-RU")} ${m.label}`;this._summElement.textContent=r}}const i=new H,X=new G(x),I=new N(X),f=new U(i),E=new F(i),d=new M(i),Z=new $(i,u.header),tt=new j(u.page),l=new q(i,u.modal),b=new K(i,_(u.cart)),R=new Y(_(u.cardPreviewTemplate),{onClick:()=>i.emit(n.BUY_CLICK,f.getSelectedProduct())}),P=new J(i,_(u.formOrder)),D=new Q(i,_(u.formContacts)),et=new W(i,_(u.successful));i.on(n.CATALOG_CHANGED,()=>{const e=f.getProductList().map(t=>new V(_(u.cardGalleryTemplate),{onClick:()=>i.emit(n.CARD_SELECTED,t)}).render(t));tt.render({catalog:e})});i.on(n.CARD_SELECTED,e=>{f.setSelectedProduct(e)});i.on(n.SELECTED_CARD_SAVE,()=>{const e=f.getSelectedProduct(),t={...e,textButton:e.price===null?g.disabled:d.checkProductInCartById(e.id)?g.delete:g.buy,statusButton:!e.price},r=R.render(t);l.render({content:r}),l.open()});i.on(n.BUY_CLICK,e=>{d.checkProductInCartById(e.id)===!1?d.addToCart(e):d.removeFromCart(e),l.close()});i.on(n.CART_CHANGED,()=>{const e=f.getSelectedProduct(),t=d.getTotalCartCount(),r={...e,textButton:g.delete},a={listOfPosition:d.getListFromCart().map((C,S)=>{const B=new z(_(u.productInCartTemplate),{onClick:()=>i.emit(n.PRODUCT_REMOVE,C)}),w={...C,index:S+1};return B.render(w)}),summ:d.getTotalCartCost(),statusButton:!d.getTotalCartCost()},h=b.render(a);l.render({content:h}),R.render(r),Z.render({counter:t})});i.on(n.CART_OPEN,()=>{l.render({content:b.render()}),l.open()});i.on(n.PRODUCT_REMOVE,e=>{d.removeFromCart(e)});i.on(n.ORDER_START,()=>{l.render({content:P.render()})});i.on(n.FORM_EDIT,e=>{E.setOrderInformation(e)});i.on(n.BUYER_CAHAGED,e=>{const t=E.validationOrderInformation(),{payment:r,address:s}=t,o={payment:r,address:s},a=!Object.values(o).every(C=>C===null),h={...e,errors:o,statusButton:a};P.render(h)});i.on(n.ORDER_SUBMIT,()=>{const e=E.validationOrderInformation();if(!Object.values(e).every(t=>t===null))l.render({content:D.render()});else{const t=d.getListFromCart().map(s=>s.id),r={...E.getOrderInformation(),total:d.getTotalCartCost(),items:t};(async()=>{try{const s=await I.postOrderOnServer(r);d.clearCart(),E.clearOrderInformation(),l.render({content:et.render({summ:s.total})})}catch(s){console.error(s)}})()}});i.on(n.CONTACT_CHANGED,e=>{const t=E.validationOrderInformation(),{email:r,phone:s}=t,o={email:r,phone:s},a=!Object.values(o).every(C=>C===null),h={...e,errors:o,statusButton:a};D.render(h)});i.on(n.MODAL_CLOSE,()=>{l.close()});try{const e=await I.getProductsFromServer();f.setProductList(e.items)}catch(e){console.error(e)}
